on:
  repository_dispatch:
    types: [builds]

name: Build Binaries

jobs:
  windows_build:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Configure Build
        run: cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" -S . -B ./build

      - name: Build Peoplemon
        run: cd build && make

      - name: Package Project
        run: |
          mkdir release
          mv Resources release
          mv PeoplemonRelease.exe release/Peoplemon.exe
          cp lib/BLIB/lib/SFML/extlibs/bin/x64/openal32.dll ./release
          Compress-Archive -Path release -DestinationPath Windows.zip
          
          mv EditorResources release
          mv PeoplemonEditorRelease.exe release/PeoplemonEditor.exe
          Compress-Archive -Path release -DestinationPath WindowsEditor.zip

      - name: Upload Game Package
        id: upload-release-game 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.client_payload.release_url }}
          asset_path: ./Windows.zip
          asset_name: Windows.zip
          asset_content_type: application/zip

      - name: Upload Editor Package
        id: upload-release-editor
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.client_payload.release_url }}
          asset_path: ./WindowsEditor.zip
          asset_name: WindowsEditor.zip
          asset_content_type: application/zip
